#!/bin/busybox sh

# Shimboot Init Script
#
# Purpose: Initialize minimal boot environment and transition to main bootloader.
# Dependencies: busybox, bootstrap.sh
# Related: bootloader/bin/bootstrap.sh
#
# This script:
# - Sets up busybox utility environment with --install for comprehensive binary access
# - Detects display firmware (frecon-lite) and configures appropriate TTY devices
# - Exports terminal environment variables for bootloader menu display
# - Executes main bootstrap.sh as PID 1 with proper TTY redirection
# - Provides fallback error handling with sleep if bootstrap fails
#
# Adapted from ChromiumOS factory shim init script for Shimboot bootloader functionality.
# Runs as the initial /init in the minimal initramfs environment.

# Copyright 2015 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.
#
# /init script for use in factory install shim.
# Note that this script uses the busybox shell (not bash, not dash).

#original: https://chromium.googlesource.com/chromiumos/platform/initramfs/+/refs/heads/main/factory_shim/init

set -x

detect_tty() {
	if [ -f "/bin/frecon-lite" ]; then
		export TTY1="/dev/pts/0"
		export TTY2="/dev/pts/1"
	else
		export TTY1="/dev/tty1"
		export TTY2="/dev/tty2"
	fi
}

setup_environment() {
	# Install additional utility programs.
	/bin/busybox --install /bin || true
}

main() {
	setup_environment
	detect_tty
	# In case an error is not handled by bootstrapping, stop here
	# so that an operator can see installation stop.
	exec bootstrap.sh <"$TTY1" >>"$TTY1" 2>&1 || sleep 1d
}

main "$@"
exit 1
