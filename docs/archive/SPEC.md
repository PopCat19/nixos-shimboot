# NixOS Shimboot Technical Specification

**Status:** Functional
**Target:** ChromeOS devices with RMA shim vulnerability
**License:** GPL-3.0 (code) / Unfree (ChromeOS artifacts)

---

## 1. Project Identity

### Core Concept
- **Shimboot:** A method to boot arbitrary Linux distributions (specifically NixOS) on locked ChromeOS hardware without modifying firmware (RW_LEGACY/UEFI not required).
- **Mechanism:** Exploits the RMA shim boot path, replacing the kernel and rootfs while maintaining the verified boot chain's signature requirements via the shim's signed kernel partition.

### Hardware Support Model
- **Supported:** dedede, octopus, zork, nissa, hatch, grunt, snappy
- **Broad:** Devices with build infrastructure (manifests/recovery URLs) present in the flake.
- **Generic:** The architecture is x86_64 board-agnostic; support requires only a valid ChromeOS recovery image and shim for the target board.

---

## 2. System Architecture

### Boot Chain
```
ChromeOS Firmware (ReadOnly/Verified)
  ↓
USB/SD Storage
  ↓
Shim Partition (Kernel + Initramfs)
  └─ Patched to execute custom bootstrap.sh instead of factory install
  ↓
BusyBox Bootloader (bootstrap.sh)
  ↓
Mounts Rootfs & Vendor Partitions
  ↓
Switch Root -> NixOS Stage 1 -> Systemd (mount patched)
```

### Partition Layout (Dynamic)
The layout is generated by `assemble-final.sh` and supports variable sizing.

```
p1: STATE       (ChromeOS metadata placeholder)
p2: KERNEL      (Signed ChromeOS kernel + patched initramfs)
p3: BOOTLOADER  (Shimboot scripts & tools)
p4: VENDOR      (Optional: Extracted ChromeOS drivers/firmware)
p5: ROOTFS      (NixOS Root Filesystem - Ext4)
```
*Note: If `inject` driver mode is used, p4 may be omitted or mapped differently.*

---

## 3. Configuration System

### Hierarchy
The configuration is tiered to allow easy customization without touching core logic.

1.  **`shimboot_config/user-config.nix`**: High-level user variables (Username, Hostname, Locale, Default Apps).
2.  **`main_configuration/`**: Full desktop environment (Hyprland, Home Manager, Themes).
3.  **`base_configuration/`**: Minimal bootable system (Kernel modules, Hardware compat, CLI tools).
4.  **`flake.nix`**: Entry point defining inputs, outputs, and board targets.

### Key Modules
| Module | Purpose |
| :--- | :--- |
| `systemd-patch` | Applies `mount_nofollow` patch to fix ChromeOS kernel symlink restrictions. |
| `kill-frecon` | Terminates ChromeOS console terminal to free the display for X11/Wayland. |
| `hardware` | Manages firmware loading, OpenGL, and brightness control. |
| `zram` | Configures memory compression (crucial for low-RAM Chromebooks). |

---

## 4. Build Pipeline

### Flow
1.  **Nix Build**: Generates raw rootfs image and extracts kernel/initramfs from shim sources.
2.  **Driver Harvest**: Extracts proprietary drivers (`/lib/modules`, `/lib/firmware`) from ChromeOS recovery images.
3.  **Assembly**:
    *   Calculates partition sizes.
    *   Integrates drivers (via separate partition or injection).
    *   Partitions and formats the disk image (`shimboot.img`).
    *   Populates bootloader and rootfs.

### Caching Strategy (Cachix)
- **Push**: `tools/push-to-cachix.sh` uploads derivations and final compressed images/manifests.
- **Pull**: `assemble-final.sh` can fetch pre-built images or pre-warm the Nix store to speed up local builds.
- **CI**: GitHub Actions workflows validate builds and push to the binary cache.

---

## 5. Tooling Ecosystem

### Build & Deploy
- **`assemble-final.sh`**: The orchestrator. Handles build, harvest, and image creation.
- **`write-shimboot-image.sh`**: Safely flashes images to USB/SD. Features:
    - System disk protection (prevents overwriting host OS).
    - UDisks integration (auto-unmounts targets).
    - Size validation and safety countdowns.

### Maintenance & Rescue
- **`tools/rescue-helper.sh`**: Interactive TUI tool for live USBs.
    - Mounts/repairs shimboot partitions.
    - Manages Nix generations (list, rollback, delete).
    - Backs up/Restores `/home` directory.
    - Chroots into installation.
- **`setup_nixos`**: Post-install wizard on the device (expands partitions, configures WiFi, setups git config).

### Development
- **`fetch-manifest.sh`**: Downloads ChromeOS shim manifests.
- **`fetch-recovery.sh`**: Updates recovery image URLs in `chromeos-sources.nix`.
- **`harvest-drivers.sh`**: Extracts proprietary blobs. Includes logic to prune unused firmware to save space.

---

## 6. User Experience

### Shell Environment
- **Shell**: Fish (default).
- **Terminal**: Kitty.
- **Prompt**: Starship.
- **Custom Functions**:
    - `nrb`: `nixos-rebuild switch` wrapper with kernel version checks.
    - `flup`: Flake update helper with rollback capability.
    - `cnup`: NixOS linting and formatting helper.
    - `fish_greeting`: Fastfetch-based status summary.

### Desktop Environment (Full Flavor)
- **WM**: Hyprland.
- **Theme**: Stylix.
- **Browser**: Zen Browser.
- **IME**: Fcitx5 (Mozc/Japanese support pre-configured).

---

## 7. Known Constraints & Workarounds

| Constraint | Workaround |
| :--- | :--- |
| **Kernel < 5.6** | `nixos-rebuild` requires `--option sandbox false` (handled by `nrb` wrapper). |
| **Symlink Restrictions** | Patched `systemd` with `mount_nofollow`. |
| **Console Lock** | `kill-frecon` service terminates factory console before DM starts. |
| **Audio** | Often non-functional due to complex topology/DSP requirements (SOF). |
| **Suspend** | Disabled via `logind` config (often causes kernel panics). |

---

## 8. Extension Points

### Adding a New Board
1.  Run `tools/fetch-manifest.sh <board>`.
2.  Run `tools/fetch-recovery.sh --board <board>`.
3.  Add board name to `supportedBoards` in `flake.nix`.
4.  Build: `./assemble-final.sh --board <board>`.

### Customizing Drivers
- **Mode**: Select between `vendor` (separate partition, cleaner) or `inject` (direct rootfs copy) via `--drivers` flag in build script.
- **Firmware Pruning**: Edit `tools/harvest-drivers.sh` to adjust the allowlist of firmware families.

---

## 9. File Structure Map

```text
├── .backup/                # Backup files
├── .github/                # GitHub Actions workflows
├── .kilocode/              # LLM workspace rules and configurations
├── bootloader/             # BusyBox scripts for the shim partition
├── flake_modules/          # Nix logic (kernel extraction, raw images, sources)
├── llm-notes/              # Development notes and conventions
├── manifests/              # JSON/Nix manifests for ChromeOS shims
├── overlays/               # Nix overlays for custom packages
├── scripts/                # Additional scripts
├── shimboot_config/        # User-facing configuration
│   ├── base_configuration/ # Minimal system modules
│   │   └── system_modules/ # System-level modules
│   │       ├── fish_functions/ # Fish shell functions
│   │       └── helpers/    # Helper scripts
│   ├── main_configuration/ # Desktop/HM modules
│   │   ├── home/           # Home Manager configurations
│   │   │   ├── hypr_config/ # Hyprland configuration
│   │   │   ├── noctalia_config/ # Noctalia shell config
│   │   │   ├── packages/   # Home packages
│   │   │   └── wallpaper/  # Wallpaper files
│   │   └── system/         # System modules for main config
│   └── user-config.nix     # Global variables
├── snapshots/              # Project state snapshots
└── tools/                  # Shell scripts (build, deploy, rescue, maintain)
```

---

**End of Specification**
For implementation details, see source files.
For community support, see GitHub discussions.
For upstream documentation, see ading2210/shimboot.
