name: build-shimboot

on:
  workflow_dispatch:
    inputs:
      board:
        description: 'Board to build'
        required: true
        default: 'dedede'
        type: choice
        options: [all, dedede, octopus, zork, nissa, hatch, grunt, snappy]
      rootfs:
        description: 'Rootfs variant'
        required: true
        default: 'minimal'
        type: choice
        options: [minimal, full]
      drivers_mode:
        description: 'Driver placement mode'
        required: true
        default: 'vendor'
        type: choice
        options: [vendor, inject, both, none]
      firmware_upstream:
        description: 'Include upstream ChromiumOS firmware'
        required: false
        default: true
        type: boolean
      inspect_after:
        description: 'Inspect final image after build'
        required: false
        default: false
        type: boolean
      prewarm_cache:
        description: 'Pre-warm Cachix cache before building'
        required: false
        default: false
        type: boolean
      push_to_cachix:
        description: 'Push to Cachix'
        required: false
        default: false
        type: boolean
      runner_type:
        description: 'Runner type (self-hosted or GitHub-hosted)'
        required: true
        default: 'ubuntu-latest'
        type: choice
        options: [ubuntu-latest, popcat19-nixos0]
      include_checksum:
        description: 'Include SHA256 checksum in packaged artifact'
        required: false
        default: true
        type: boolean

env:
  NIXPKGS_ALLOW_UNFREE: 1

jobs:
  build:
    runs-on: ${{ github.event.inputs.runner_type || 'ubuntu-latest' }}
    permissions:
      contents: write

    strategy:
      fail-fast: false
      matrix:
        board: >-
          ${{
            github.event.inputs.board == 'all'
            && fromJSON('["dedede", "octopus", "zork", "nissa", "hatch", "grunt", "snappy"]')
            || fromJSON(format('["{0}"]', github.event.inputs.board))
          }}

    steps:
      - name: Maximize build space
        run: |
          df -h
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Reclaim disk space for Nix
        uses: wimpysworld/nothing-but-nix@main
        with:
          hatchet-protocol: 'cleave'

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: |
            experimental-features = nix-command flakes
            accept-flake-config = true
            auto-optimise-store = true
            substituters = https://cache.nixos.org https://shimboot-systemd-nixos.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= shimboot-systemd-nixos.cachix.org-1:vCWmEtJq7hA2UOLN0s3njnGs9/EuX06kD7qOJMo2kAA=

      - name: Setup Cachix
        if: ${{ github.event.inputs.push_to_cachix == 'true' || github.event_name == 'release' }}
        uses: cachix/cachix-action@v14
        with:
          name: shimboot-systemd-nixos
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Build Nix components
        run: |
          BOARD="${{ matrix.board }}"
          ROOTFS="${{ github.event.inputs.rootfs || 'minimal' }}"

          echo "ðŸ”¨ Building for: $BOARD (rootfs: $ROOTFS)"

          nix build --impure --accept-flake-config \
            .#chromeos-shim-${BOARD} \
            .#extracted-kernel-${BOARD} \
            .#initramfs-patching-${BOARD} \
            --print-out-paths

          if [ "$ROOTFS" = "minimal" ]; then
            nix build --impure --accept-flake-config .#raw-rootfs-minimal --print-out-paths
          else
            nix build --impure --accept-flake-config .#raw-rootfs --print-out-paths
          fi

          df -h

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            parted gdisk e2fsprogs util-linux pv zstd vboot-utils

      - name: Assemble image
        run: |
          if [ -e /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
            source /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
          fi

          echo "ðŸ’¾ Available space before assembly:"
          df -h

          # Build assemble-final.sh command with all options
          ASSEMBLE_CMD=(
            ./assemble-final.sh
            --board "${{ matrix.board }}"
            --rootfs "${{ github.event.inputs.rootfs || 'minimal' }}"
            --drivers "${{ github.event.inputs.drivers_mode || 'vendor' }}"
          )

          # Add firmware upstream flag
          if [ "${{ github.event.inputs.firmware_upstream }}" = "false" ]; then
            ASSEMBLE_CMD+=(--no-firmware-upstream)
          else
            ASSEMBLE_CMD+=(--firmware-upstream)
          fi

          # Add inspect flag
          if [ "${{ github.event.inputs.inspect_after }}" = "true" ]; then
            ASSEMBLE_CMD+=(--inspect)
          fi

          # Add prewarm cache flag
          if [ "${{ github.event.inputs.prewarm_cache }}" = "true" ]; then
            ASSEMBLE_CMD+=(--prewarm-cache)
          fi

          echo "ðŸš€ Running: ${ASSEMBLE_CMD[*]}"
          sudo -E env "PATH=$PATH" "NIX_PATH=$NIX_PATH" \
            BOARD="${{ matrix.board }}" \
            "${ASSEMBLE_CMD[@]}"

          echo "ðŸ’¾ Available space after assembly:"
          df -h

      - name: Compress and rename
        run: |
          set -e

          # Detect working directory where shimboot.img is located
          if [ -f "/nix/work/shimboot.img" ]; then
            WORKDIR="/nix/work"
          elif [ -f "work/shimboot.img" ]; then
            WORKDIR="work"
          else
            echo "âŒ Error: shimboot.img not found!"
            sudo find / -name "shimboot.img" -type f 2>/dev/null | head -10
            exit 1
          fi

          if ! sudo parted -s "$WORKDIR/shimboot.img" print >/dev/null 2>&1; then
            echo "âŒ Error: shimboot.img is not a valid disk image!"
            exit 1
          fi

          if [ "$WORKDIR" = "/nix/work" ]; then
            sudo chown -R $(whoami):$(whoami) "$WORKDIR"
          fi

          cd "$WORKDIR"

          ARTIFACT_TAG="${{ matrix.board }}-shimboot-${{ github.event.inputs.rootfs || 'minimal' }}"
          mkdir -p flat

          echo "ðŸ“¦ Compressing ${ARTIFACT_TAG}.img.zst (this may take a while)..."
          echo "   â–¶ Showing progress with pv and verbose zstd output"

          # Use pv to show throughput, ETA, and elapsed time
          # Combine with zstd --verbose for inline compression stats
          stdbuf -oL pv -p -t -e -r -a shimboot.img | \
            stdbuf -oL zstd -19 --long --verbose -T0 -o "flat/${ARTIFACT_TAG}.img.zst" | \
            tee compression.log

          echo ""
          echo "âœ… Compression completed."
          echo "ðŸ“„ Compression stats summary:"
          tail -n 10 compression.log || true

          # Optional checksum generation (default: true)
          if [ "${{ github.event.inputs.include_checksum || 'true' }}" = "true" ]; then
            echo "ðŸ” Generating checksum..."
            (cd flat && sha256sum "${ARTIFACT_TAG}.img.zst" > "${ARTIFACT_TAG}.img.zst.sha256")
          fi

          echo "ðŸ“¦ Zipping flat files..."
          cd flat
          if [ -f "${ARTIFACT_TAG}.img.zst.sha256" ]; then
            echo "   â–¶ Creating ZIP archive with checksum (verbose mode)"
            stdbuf -oL zip -9 -v "../${ARTIFACT_TAG}.zip" "${ARTIFACT_TAG}.img.zst" "${ARTIFACT_TAG}.img.zst.sha256" | tee ../zip-progress.log
          else
            echo "   â–¶ Creating ZIP archive (no checksum, verbose mode)"
            stdbuf -oL zip -9 -v "../${ARTIFACT_TAG}.zip" "${ARTIFACT_TAG}.img.zst" | tee ../zip-progress.log
          fi

          cd ..
          echo ""
          echo "ðŸ’¡ Final ZIP package:"
          unzip -l "${ARTIFACT_TAG}.zip"

          echo ""
          echo "ðŸ“„ ZIP stats summary:"
          tail -n 5 zip-progress.log || true

          # Clean up working files
          rm -rf flat shimboot.img

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.board }}-shimboot-${{ github.event.inputs.rootfs || 'minimal' }}
          path: |
            /nix/work/${{ matrix.board }}-shimboot-${{ github.event.inputs.rootfs || 'minimal' }}.zip
            work/${{ matrix.board }}-shimboot-${{ github.event.inputs.rootfs || 'minimal' }}.zip
          retention-days: 30