# Build Shimboot Workflow
#
# Purpose: Build ChromeOS shimboot images for specified boards with configurable rootfs variants
# Dependencies: GitHub Actions runners, Nix, Cachix (optional)
# Related: assemble-final.sh, flake.nix
#
# This workflow:
# - Builds NixOS shimboot images for ChromeOS devices
# - Supports multiple board variants and rootfs configurations
# - Optimizes GitHub Actions runner space for large builds
# - Caches build artifacts using Magic Nix Cache and optional Cachix
# - Assembles final bootable images with vendor drivers

name: build-shimboot

# Workflow Triggers
# Manual dispatch with user inputs for board selection, rootfs variant, and caching options

on:
  workflow_dispatch:
    inputs:
      board:
        description: 'Board to build'
        required: true
        default: 'dedede'
        type: choice
        options: [dedede, octopus, zork, nissa, hatch, grunt, snappy]
      rootfs:
        description: 'Rootfs variant'
        required: true
        default: 'minimal'
        type: choice
        options: [minimal, full]
      push_to_cachix:
        description: 'Push to Cachix'
        required: false
        default: false
        type: boolean

# Environment Variables
# Allow unfree packages in Nix builds for proprietary components

env:
  NIXPKGS_ALLOW_UNFREE: 1

# Job Definitions
# Single build job with matrix strategy for different boards

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    # Build Strategy
    # Matrix build for selected board, fail-fast disabled to build all variants
    strategy:
      fail-fast: false
      matrix:
        board: ${{ github.event.inputs.board == 'all' && fromJSON('["dedede"]') || fromJSON(format('["{0}"]', github.event.inputs.board || 'dedede')) }}

    # Build Steps
    # Sequential steps to prepare environment, build components, and assemble final image
    steps:
      # Environment Preparation
      # Clean up GitHub Actions runner to maximize available disk space for Nix builds

      # âœ¨ NEW: Maximize space BEFORE anything else
      - name: Maximize build space
        run: |
          df -h
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      # Repository Setup
      # Checkout full repository history for complete build context

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # âœ¨ NEW: Nothing but Nix for massive space reclamation
      - name: Reclaim disk space for Nix
        uses: wimpysworld/nothing-but-nix@main
        with:
          hatchet-protocol: 'cleave'  # 115GB mode

      # Nix Installation and Configuration
      # Install Nix with flake support and configure binary caches

      # Install Nix with Determinate Systems installer (faster)
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: |
            experimental-features = nix-command flakes
            accept-flake-config = true
            auto-optimise-store = true
            substituters = https://cache.nixos.org https://shimboot-systemd-nixos.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= shimboot-systemd-nixos.cachix.org-1:vCWmEtJq7hA2UOLN0s3njnGs9/EuX06kD7qOJMo2kAA=

      # âœ¨ NEW: Magic Nix Cache (auto-caching to GHA cache)
      - name: Setup Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v2

      # Optional: Setup Cachix for external binary cache
      - name: Setup Cachix
        if: ${{ github.event.inputs.push_to_cachix == 'true' || github.event_name == 'release' }}
        uses: cachix/cachix-action@v14
        with:
          name: shimboot-systemd-nixos
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      # Nix Component Building
      # Build all required Nix derivations for the selected board and rootfs variant

      # Build Nix components
      - name: Build Nix components
        run: |
          BOARD="${{ matrix.board }}"
          ROOTFS="${{ github.event.inputs.rootfs || 'minimal' }}"

          echo "ðŸ”¨ Building for: $BOARD (rootfs: $ROOTFS)"

          # Build all derivations
          nix build --impure --accept-flake-config \
            .#chromeos-shim-${BOARD} \
            .#extracted-kernel-${BOARD} \
            .#initramfs-patching-${BOARD} \
            --print-out-paths

          if [ "$ROOTFS" = "minimal" ]; then
            nix build --impure --accept-flake-config .#raw-rootfs-minimal --print-out-paths
          else
            nix build --impure --accept-flake-config .#raw-rootfs --print-out-paths
          fi

          df -h

      # Assembly Preparation
      # Install system tools required for image assembly and compression

      # Install assembly dependencies
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            parted gdisk e2fsprogs util-linux pv zstd vboot-utils

      # Assemble final image
      - name: Assemble image
        run: |
          # Ensure Nix environment is available for root
          if [ -e /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
            source /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
          fi

          # Re-run assemble-final.sh with preserved PATH
          sudo -E env "PATH=$PATH" "NIX_PATH=$NIX_PATH" \
            BOARD="${{ matrix.board }}" \
            ./assemble-final.sh \
              --board "${{ matrix.board }}" \
              --rootfs "${{ github.event.inputs.rootfs || 'minimal' }}" \
              --drivers vendor

      # Artifact Preparation
      # Compress final image and generate checksum for distribution

      - name: Compress image
        run: |
          # Detect where assemble-final.sh placed the image
          if [ -f "/nix/work/shimboot.img" ]; then
            WORKDIR="/nix/work"
            echo "âœ… Using CI work directory: /nix/work"
          elif [ -f "work/shimboot.img" ]; then
            WORKDIR="work"
            echo "âœ… Using local work directory: work"
          else
            echo "âŒ Error: shimboot.img not found in expected locations!"
            echo "Searching for shimboot.img..."
            find . -name "shimboot.img" -type f 2>/dev/null || echo "No shimboot.img found anywhere"
            exit 1
          fi

          echo "ðŸ“¦ Compressing image at: $WORKDIR/shimboot.img"
          cd "$WORKDIR"

          pv shimboot.img | zstd -19 -T0 -o shimboot.img.zst
          sha256sum shimboot.img.zst > shimboot.img.zst.sha256

          echo "âœ… Compressed: $(du -h shimboot.img.zst | cut -f1)"
          rm shimboot.img

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: shimboot-${{ matrix.board }}-${{ github.event.inputs.rootfs || 'minimal' }}
          path: |
            /nix/work/shimboot.img.zst
            /nix/work/shimboot.img.zst.sha256
            work/shimboot.img.zst
            work/shimboot.img.zst.sha256
          retention-days: 30