name: manual-release

on:
  workflow_dispatch:
    inputs:
      drivers_mode:
        description: 'Driver placement mode'
        required: true
        default: 'vendor'
        type: choice
        options: [vendor, inject, both, none]
      firmware_upstream:
        description: 'Include upstream ChromiumOS firmware'
        required: false
        default: true
        type: boolean
      runner_type:
        description: 'Runner type (self-hosted or GitHub-hosted)'
        required: true
        default: 'ubuntu-latest'
        type: choice
        options: [ubuntu-latest, popcat19-nixos0]
      include_checksum:
        description: 'Include SHA256 checksum in packaged artifact'
        required: false
        default: true
        type: boolean

env:
  NIXPKGS_ALLOW_UNFREE: 1

jobs:
  build-all:
    runs-on: ${{ github.event.inputs.runner_type || 'ubuntu-latest' }}
    permissions:
      contents: write

    strategy:
      fail-fast: false
      matrix:
        board: [dedede, octopus, zork, nissa, hatch, grunt, snappy]

    steps:
      - name: Maximize build space
        run: |
          df -h
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Reclaim disk space for Nix
        uses: wimpysworld/nothing-but-nix@main
        with:
          hatchet-protocol: 'cleave'

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: |
            experimental-features = nix-command flakes
            accept-flake-config = true
            auto-optimise-store = true
            substituters = https://cache.nixos.org https://shimboot-systemd-nixos.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= shimboot-systemd-nixos.cachix.org-1:vCWmEtJq7hA2UOLN0s3njnGs9/EuX06kD7qOJMo2kAA=

      - name: Setup Cachix
        uses: cachix/cachix-action@v14
        with:
          name: shimboot-systemd-nixos
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Build Nix components
        run: |
          BOARD="${{ matrix.board }}"
          echo "ðŸ”¨ Building minimal rootfs for: $BOARD"

          # RETRY LOOP FOR NIX BUILD
          success=false
          for i in {1..3}; do
            echo "ðŸ”„ [Attempt $i/3] Building Nix components..."
            if nix build --impure --accept-flake-config \
              .#chromeos-shim-${BOARD} \
              .#extracted-kernel-${BOARD} \
              .#initramfs-patching-${BOARD} \
              .#raw-rootfs-minimal \
              --print-out-paths; then
              success=true
              echo "âœ… Build successful."
              break
            fi
            echo "âš ï¸ [Attempt $i/3] Build failed. Retrying in 10 seconds..."
            sleep 10
          done

          if [ "$success" = "false" ]; then
            echo "âŒ Failed to build components after 3 attempts."
            exit 1
          fi

          df -h

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            parted gdisk e2fsprogs util-linux pv zstd vboot-utils

      - name: Assemble image
        run: |
          if [ -e /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
            source /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
          fi

          echo "ðŸ’¾ Available space before assembly:"
          df -h

          # Build assemble-final.sh command with release-specific options
          ASSEMBLE_CMD=(
            ./assemble-final.sh
            --board "${{ matrix.board }}"
            --rootfs minimal
            --drivers "${{ github.event.inputs.drivers_mode || 'vendor' }}"
          )

          # Add firmware upstream flag
          if [ "${{ github.event.inputs.firmware_upstream }}" = "false" ]; then
            ASSEMBLE_CMD+=(--no-firmware-upstream)
          else
            ASSEMBLE_CMD+=(--firmware-upstream)
          fi

          # RETRY LOOP FOR ASSEMBLY
          success=false
          for i in {1..3}; do
            echo "ðŸš€ [Attempt $i/3] Running: ${ASSEMBLE_CMD[*]}"
            if sudo -E env "PATH=$PATH" "NIX_PATH=$NIX_PATH" \
              BOARD="${{ matrix.board }}" \
              "${ASSEMBLE_CMD[@]}"; then
              success=true
              echo "âœ… Assembly successful."
              break
            fi
            echo "âš ï¸ [Attempt $i/3] Assembly failed. Retrying in 10 seconds..."
            sleep 10
          done

          if [ "$success" = "false" ]; then
            echo "âŒ Assembly failed after 3 attempts."
            exit 1
          fi

          echo "ðŸ’¾ Available space after assembly:"
          df -h

      - name: Compress and prepare release artifact
        run: |
          set -e
          
          # Defined path logic matching the script's new behavior
          # We prefer the CI path /nix/work if it exists
          CI_WORKDIR="/nix/work/${{ matrix.board }}"
          LOCAL_WORKDIR="work/${{ matrix.board }}"
          
          if [ -f "$CI_WORKDIR/shimboot.img" ]; then
            WORKDIR="$CI_WORKDIR"
          elif [ -f "$LOCAL_WORKDIR/shimboot.img" ]; then
            WORKDIR="$LOCAL_WORKDIR"
          else
            echo "âŒ Error: shimboot.img not found in expected paths:"
            echo "   Checked: $CI_WORKDIR"
            echo "   Checked: $LOCAL_WORKDIR"
            # Debug find to see where it went
            sudo find /nix/work -name "shimboot.img" -maxdepth 3 2>/dev/null || true
            exit 1
          fi

          if ! sudo parted -s "$WORKDIR/shimboot.img" print >/dev/null 2>&1; then
            echo "âŒ Error: shimboot.img is not a valid disk image!"
            exit 1
          fi

          sudo chown -R $(whoami):$(whoami) "$WORKDIR"
          cd "$WORKDIR"

          ARTIFACT_NAME="${{ matrix.board }}-shimboot-minimal"

          echo "ðŸ“¦ Compressing ${ARTIFACT_NAME}.img.zst (this may take a while)..."
          stdbuf -oL pv -p -t -e -r -a shimboot.img | \
            stdbuf -oL zstd -19 --long --verbose -T0 -o "${ARTIFACT_NAME}.img.zst" | tee compression.log

          echo ""
          echo "âœ… Compression completed."
          echo "ðŸ“„ Compression stats summary:"
          tail -n 10 compression.log || true

          echo "ðŸ” Calculating checksum (printed only):"
          sha256sum "${ARTIFACT_NAME}.img.zst"

          rm -f shimboot.img compression.log
          OUTPUT_DIR=$(dirname "$WORKDIR")
          echo "ðŸ“ Preparing output directory: $OUTPUT_DIR"
          sudo mkdir -p "$OUTPUT_DIR"
          sudo chown -R $(whoami):$(whoami) "$OUTPUT_DIR"

          echo "ðŸ“¦ Moving artifact to $OUTPUT_DIR/${ARTIFACT_NAME}.img.zst"
          sudo mv "${ARTIFACT_NAME}.img.zst" "$OUTPUT_DIR/"

          cd "$OUTPUT_DIR"
          echo "âœ… Artifact ready: $(pwd)/${ARTIFACT_NAME}.img.zst"

          # Move into GitHub workspace so upload-artifact can see it
          echo "ðŸ“¦ Copying artifact into workflow workspace (${GITHUB_WORKSPACE})"
          cp "${ARTIFACT_NAME}.img.zst" "${GITHUB_WORKSPACE}/"

          if [ "${{ github.event.inputs.include_checksum }}" = "true" ]; then
            sha256sum "${ARTIFACT_NAME}.img.zst" > "${GITHUB_WORKSPACE}/${ARTIFACT_NAME}.img.zst.sha256"
            echo "âœ… Checksum saved to ${GITHUB_WORKSPACE}/${ARTIFACT_NAME}.img.zst.sha256"
          fi

          # Cleanup safely
          sudo rm -rf "$WORKDIR"

      - name: Upload zipped artifact for release
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.board }}-shimboot-minimal
          path: ${{ matrix.board }}-shimboot-minimal.img.zst

  create-release:
    needs: build-all
    runs-on: ${{ github.event.inputs.runner_type || 'ubuntu-latest' }}
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Generate release metadata
        id: metadata
        run: |
          TIMESTAMP=$(date -u '+%Y.%m.%d.%H%M-UTC')
          echo "timestamp=${TIMESTAMP}" >> "$GITHUB_OUTPUT"

          BRANCH="${GITHUB_REF#refs/heads/}"
          COMMIT=$(git rev-parse --short HEAD)
          echo "branch=${BRANCH}" >> "$GITHUB_OUTPUT"
          echo "commit=${COMMIT}" >> "$GITHUB_OUTPUT"

          TITLE="${TIMESTAMP} build artifacts"
          BODY="Minimal nixos-shimboot build artifacts from ${BRANCH} at ${COMMIT}"
          
          echo "title=${TITLE}" >> "$GITHUB_OUTPUT"
          echo "body<<EOF" >> "$GITHUB_OUTPUT"
          echo "${BODY}" >> "$GITHUB_OUTPUT"
          echo "" >> "$GITHUB_OUTPUT"
          echo "## ðŸ“¦ Artifacts" >> "$GITHUB_OUTPUT"
          echo "" >> "$GITHUB_OUTPUT"
          echo "All boards built with minimal rootfs configuration." >> "$GITHUB_OUTPUT"
          echo "" >> "$GITHUB_OUTPUT"
          echo "### Configuration" >> "$GITHUB_OUTPUT"
          echo "- Driver mode: ${{ github.event.inputs.drivers_mode || 'vendor' }}" >> "$GITHUB_OUTPUT"
          echo "- Upstream firmware: ${{ github.event.inputs.firmware_upstream != 'false' && 'enabled' || 'disabled' }}" >> "$GITHUB_OUTPUT"
          echo "" >> "$GITHUB_OUTPUT"
          echo "### Boards Included" >> "$GITHUB_OUTPUT"
          echo "- dedede" >> "$GITHUB_OUTPUT"
          echo "- octopus" >> "$GITHUB_OUTPUT"
          echo "- zork" >> "$GITHUB_OUTPUT"
          echo "- nissa" >> "$GITHUB_OUTPUT"
          echo "- hatch" >> "$GITHUB_OUTPUT"
          echo "- grunt" >> "$GITHUB_OUTPUT"
          echo "- snappy" >> "$GITHUB_OUTPUT"
          echo "" >> "$GITHUB_OUTPUT"
          echo "### Usage" >> "$GITHUB_OUTPUT"
          echo '```bash' >> "$GITHUB_OUTPUT"
          echo "# Download and decompress" >> "$GITHUB_OUTPUT"
          echo "unzip <board>-shimboot-minimal.zip" >> "$GITHUB_OUTPUT"
          echo "zstd -d <board>-shimboot-minimal.img.zst" >> "$GITHUB_OUTPUT"
          echo "" >> "$GITHUB_OUTPUT"
          echo "# Verify checksum" >> "$GITHUB_OUTPUT"
          echo "sha256sum -c <board>-shimboot-minimal.img.zst.sha256" >> "$GITHUB_OUTPUT"
          echo "" >> "$GITHUB_OUTPUT"
          echo "# Flash to USB" >> "$GITHUB_OUTPUT"
          echo "sudo dd if=<board>-shimboot-minimal.img of=/dev/sdX bs=4M status=progress" >> "$GITHUB_OUTPUT"
          echo '```' >> "$GITHUB_OUTPUT"
          echo "" >> "$GITHUB_OUTPUT"
          echo "---" >> "$GITHUB_OUTPUT"
          echo "_Built from commit ${COMMIT} on ${BRANCH}_" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.metadata.outputs.timestamp }}
          name: ${{ steps.metadata.outputs.title }}
          body: ${{ steps.metadata.outputs.body }}
          draft: true
          prerelease: false
          files: |
            release-artifacts/**/*.img.zst