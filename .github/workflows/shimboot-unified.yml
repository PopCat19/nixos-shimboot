name: shimboot-unified

on:
  workflow_dispatch:
    inputs:
      # --- Scoping ---
      board:
        description: 'Target Board'
        required: true
        default: 'dedede'
        type: choice
        options: [all, dedede, octopus, zork, nissa, hatch, grunt, snappy]
      create_release:
        description: 'Publish as GitHub Release (requires board=all usually)'
        required: false
        default: false
        type: boolean
      
      # --- Build Configuration ---
      rootfs:
        description: 'Rootfs Variant'
        required: true
        default: 'minimal'
        type: choice
        options: [minimal, full]
      drivers_mode:
        description: 'Driver Mode'
        required: true
        default: 'vendor'
        type: choice
        options: [vendor, inject, both, none]
      firmware_upstream:
        description: 'Include upstream firmware'
        required: false
        default: true
        type: boolean
      
      # --- Advanced / Debug ---
      build_mode:
        description: 'Build Mode'
        required: true
        default: 'full'
        type: choice
        options:
          - full          # Build, assemble, artifact
          - cachix-only   # Build Nix derivation only, push to cache
      runner_type:
        description: 'Runner'
        required: true
        default: 'ubuntu-latest'
        type: choice
        options: [ubuntu-latest, popcat19-nixos0]
      include_checksum:
        description: 'Generate SHA256 checksum'
        required: false
        default: true
        type: boolean
      inspect_after:
        description: 'Debug: Inspect image partition table'
        required: false
        default: false
        type: boolean

env:
  NIXPKGS_ALLOW_UNFREE: 1

jobs:
  # ==================================================================
  # JOB 1: BUILD & ASSEMBLE
  # ==================================================================
  build:
    runs-on: ${{ github.event.inputs.runner_type || 'ubuntu-latest' }}
    permissions:
      contents: write # Required for caching/uploads

    strategy:
      fail-fast: false
      matrix:
        # JSON logic to handle 'all' vs single board selection
        board: >-
          ${{
            github.event.inputs.board == 'all'
            && fromJSON('["dedede", "octopus", "zork", "nissa", "hatch", "grunt", "snappy"]')
            || fromJSON(format('["{0}"]', github.event.inputs.board))
          }}

    steps:
      - name: Maximize build space
        run: |
          df -h
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Reclaim disk space for Nix
        uses: wimpysworld/nothing-but-nix@main
        with:
          hatchet-protocol: 'cleave'

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: |
            experimental-features = nix-command flakes
            accept-flake-config = true
            auto-optimise-store = true
            substituters = https://cache.nixos.org https://shimboot-systemd-nixos.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= shimboot-systemd-nixos.cachix.org-1:vCWmEtJq7hA2UOLN0s3njnGs9/EuX06kD7qOJMo2kAA=

      - name: Setup Cachix
        uses: cachix/cachix-action@v14
        with:
          name: shimboot-systemd-nixos
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          # We manually push to control exactly what gets cached
          skipPush: true

      - name: Build Nix components
        run: |
          BOARD="${{ matrix.board }}"
          ROOTFS="${{ github.event.inputs.rootfs || 'minimal' }}"

          echo "ðŸ”¨ Building core components for: $BOARD"

          # 3-Attempt Retry Loop for Nix Build
          success=false
          for i in {1..3}; do
            echo "ðŸ”„ [Attempt $i/3] Building..."
            if nix build --impure --accept-flake-config \
              .#chromeos-shim-${BOARD} \
              .#extracted-kernel-${BOARD} \
              .#initramfs-patching-${BOARD} \
              --print-out-paths; then
              success=true
              echo "âœ… Core build successful."
              break
            fi
            echo "âš ï¸ [Attempt $i/3] Failed. Retrying in 10s..."
            sleep 10
          done

          if [ "$success" = "false" ]; then echo "âŒ Core build failed."; exit 1; fi

          # Build RootFS (Separate step)
          ROOTFS_ATTR="raw-rootfs"
          [ "$ROOTFS" = "minimal" ] && ROOTFS_ATTR="raw-rootfs-minimal"
          
          echo "ðŸ”¨ Building RootFS: $ROOTFS_ATTR"
          nix build --impure --accept-flake-config ".#${ROOTFS_ATTR}" --print-out-paths

      - name: Explicitly Push to Cachix
        if: ${{ github.event.inputs.build_mode == 'cachix-only' || github.event.inputs.build_mode == 'full' }}
        env:
          CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
        run: |
          chmod +x tools/push-to-cachix.sh
          echo "ðŸš€ Pushing build artifacts to Cachix..."
          ./tools/push-to-cachix.sh \
            --board "${{ matrix.board }}" \
            --rootfs "${{ github.event.inputs.rootfs || 'minimal' }}" \
            --drivers "${{ github.event.inputs.drivers_mode || 'vendor' }}" \
            --skip-image

      - name: Install Assembly Dependencies
        if: ${{ github.event.inputs.build_mode == 'full' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y parted gdisk e2fsprogs util-linux pv zstd vboot-utils

      - name: Assemble Image
        if: ${{ github.event.inputs.build_mode == 'full' }}
        run: |
          # Load Nix environment
          if [ -e /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
            source /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
          fi

          # Construct Command
          ASSEMBLE_CMD=(
            ./assemble-final.sh
            --board "${{ matrix.board }}"
            --rootfs "${{ github.event.inputs.rootfs || 'minimal' }}"
            --drivers "${{ github.event.inputs.drivers_mode || 'vendor' }}"
          )

          # Add Boolean Flags
          [ "${{ github.event.inputs.firmware_upstream }}" = "false" ] && ASSEMBLE_CMD+=(--no-firmware-upstream) || ASSEMBLE_CMD+=(--firmware-upstream)
          [ "${{ github.event.inputs.inspect_after }}" = "true" ] && ASSEMBLE_CMD+=(--inspect)

          # 3-Attempt Retry Loop for Assembly
          success=false
          for i in {1..3}; do
            echo "ðŸš€ [Attempt $i/3] Assembling..."
            if sudo -E env "PATH=$PATH" "NIX_PATH=$NIX_PATH" BOARD="${{ matrix.board }}" "${ASSEMBLE_CMD[@]}"; then
              success=true
              echo "âœ… Assembly successful."
              break
            fi
            echo "âš ï¸ [Attempt $i/3] Failed. Retrying in 10s..."
            sleep 10
          done

          if [ "$success" = "false" ]; then echo "âŒ Assembly failed."; exit 1; fi

      - name: Compress and Artifact
        if: ${{ github.event.inputs.build_mode == 'full' }}
        run: |
          set -e

          # Detect working directory
          CI_WORKDIR="/nix/work/${{ matrix.board }}"
          LOCAL_WORKDIR="work/${{ matrix.board }}"

          if [ -f "$CI_WORKDIR/shimboot.img" ]; then
            WORKDIR="$CI_WORKDIR"
          elif [ -f "$LOCAL_WORKDIR/shimboot.img" ]; then
            WORKDIR="$LOCAL_WORKDIR"
          else
            echo "âŒ shimboot.img not found"; exit 1
          fi

          sudo chown -R $(whoami):$(whoami) "$WORKDIR"
          cd "$WORKDIR"

          ARTIFACT_BASE="${{ matrix.board }}-shimboot-${{ github.event.inputs.rootfs }}"

          echo "ðŸ“¦ Compressing..."
          stdbuf -oL pv shimboot.img | stdbuf -oL zstd -19 --long -T0 -o "${ARTIFACT_BASE}.img.zst"

          # Save checksum
          if [ "${{ github.event.inputs.include_checksum }}" = "true" ]; then
            sha256sum "${ARTIFACT_BASE}.img.zst" > "${ARTIFACT_BASE}.img.zst.sha256"
          fi

          # Safe writable upload location
          ARTIFACT_DIR="${GITHUB_WORKSPACE}/artifacts/${{ matrix.board }}"
          mkdir -p "$ARTIFACT_DIR"

          mv "${ARTIFACT_BASE}.img.zst"* "$ARTIFACT_DIR/"

          # Cleanup
          sudo rm -f shimboot.img

      - name: Upload Artifact
        if: ${{ github.event.inputs.build_mode == 'full' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.board }}-shimboot-${{ github.event.inputs.rootfs }}
          path: artifacts/${{ matrix.board }}/*

  # ==================================================================
  # JOB 2: RELEASE (Conditional)
  # ==================================================================
  create-release:
    needs: build
    if: ${{ github.event.inputs.create_release == 'true' && github.event.inputs.build_mode == 'full' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
          merge-multiple: true

      - name: Generate Release Metadata
        id: metadata
        run: |
          TIMESTAMP=$(date -u '+%Y.%m.%d.%H%M-UTC')
          COMMIT=$(git rev-parse --short HEAD)
          BRANCH="${GITHUB_REF#refs/heads/}"
          
          echo "timestamp=${TIMESTAMP}" >> "$GITHUB_OUTPUT"
          
          # Generate Release Body
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "body<<$EOF" >> "$GITHUB_OUTPUT"
          echo "## Shimboot Release (${TIMESTAMP})" >> "$GITHUB_OUTPUT"
          echo "Built from branch **${BRANCH}** at commit \`${COMMIT}\`." >> "$GITHUB_OUTPUT"
          echo "" >> "$GITHUB_OUTPUT"
          echo "### Configuration" >> "$GITHUB_OUTPUT"
          echo "- **Rootfs**: ${{ github.event.inputs.rootfs }}" >> "$GITHUB_OUTPUT"
          echo "- **Drivers**: ${{ github.event.inputs.drivers_mode }}" >> "$GITHUB_OUTPUT"
          echo "- **Firmware Upstream**: ${{ github.event.inputs.firmware_upstream }}" >> "$GITHUB_OUTPUT"
          echo "" >> "$GITHUB_OUTPUT"
          echo "### Usage (replace BOARD and sdX with actual values)" >> "$GITHUB_OUTPUT"
          echo "- **BOARD**: Replace with your downloaded board name (e.g., dedede, octopus, etc.)" >> "$GITHUB_OUTPUT"
          echo "- **sdX**: Replace with your actual USB drive device (e.g., sdb, sdc, etc.)" >> "$GITHUB_OUTPUT"
          echo "" >> "$GITHUB_OUTPUT"
          echo "#### Linux/macOS" >> "$GITHUB_OUTPUT"
          echo "**âš ï¸ Requires root privileges (sudo/su)**" >> "$GITHUB_OUTPUT"
          echo "" >> "$GITHUB_OUTPUT"
          echo "**Prerequisites:** Install zstd utility if not already available" >> "$GITHUB_OUTPUT"
          echo "- **Package Manager (preferred):**" >> "$GITHUB_OUTPUT"
          echo "  - Ubuntu/Debian: `sudo apt install zstd`" >> "$GITHUB_OUTPUT"
          echo "  - macOS: `brew install zstd` or `sudo port install zstd`" >> "$GITHUB_OUTPUT"
          echo "  - Fedora/RHEL: `sudo dnf install zstd` or `sudo yum install zstd`" >> "$GITHUB_OUTPUT"
          echo "- **Nix (if available):** `nix-shell -p zstd`" >> "$GITHUB_OUTPUT"
          echo "- **Manual install:** Download from https://facebook.github.io/zstd/" >> "$GITHUB_OUTPUT"
          echo "" >> "$GITHUB_OUTPUT"
          echo "1. Extract the image:" >> "$GITHUB_OUTPUT"
          echo '```bash' >> "$GITHUB_OUTPUT"
          echo "zstd -d BOARD-shimboot-${{ github.event.inputs.rootfs }}.img.zst" >> "$GITHUB_OUTPUT"
          echo '```' >> "$GITHUB_OUTPUT"
          echo "" >> "$GITHUB_OUTPUT"
          echo "2. Write to USB drive:" >> "$GITHUB_OUTPUT"
          echo '```bash' >> "$GITHUB_OUTPUT"
          echo "sudo dd if=BOARD-shimboot-${{ github.event.inputs.rootfs }}.img of=/dev/sdX bs=4M oflag=direct conv=fdatasync status=progress" >> "$GITHUB_OUTPUT"
          echo '```' >> "$GITHUB_OUTPUT"
          echo "" >> "$GITHUB_OUTPUT"
          echo "#### Windows" >> "$GITHUB_OUTPUT"
          echo "1. Extract the image (use **7-Zip**):" >> "$GITHUB_OUTPUT"
          echo "   - Download and install 7-Zip: https://www.7-zip.org/" >> "$GITHUB_OUTPUT"
          echo "   - Right-click BOARD-shimboot-${{ github.event.inputs.rootfs }}.img.zst â†’ 7-Zip â†’ Extract Here" >> "$GITHUB_OUTPUT"
          echo "" >> "$GITHUB_OUTPUT"
          echo "2. Write to USB drive (use **Rufus**):" >> "$GITHUB_OUTPUT"
          echo "   - Download Rufus: https://rufus.ie/" >> "$GITHUB_OUTPUT"
          echo "   - Select the extracted BOARD-shimboot-${{ github.event.inputs.rootfs }}.img file" >> "$GITHUB_OUTPUT"
          echo "   - Choose target USB drive" >> "$GITHUB_OUTPUT"
          echo "   - Click START and select 'DD Image mode' (writes image byte-for-byte, preserving GPT partition tables)" >> "$GITHUB_OUTPUT"
          echo "$EOF" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.metadata.outputs.timestamp }}
          name: ${{ steps.metadata.outputs.timestamp }} Build
          body: ${{ steps.metadata.outputs.body }}
          draft: true
          files: release-artifacts/*