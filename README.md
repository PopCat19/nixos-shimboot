# CURRENT STATE: Boots, but not ready (yet)
Check [progress and obstacles](#progress-and-obstacles) for current progress on this branch.

> [!WARNING]  
> ## This is a 'vibecoded' Proof-of-Concept project  
> As mentioned above:  
> **This repository and its codebase is mostly generated by a Large-Language Model (such as GPT-5, GLM-4.6) directed by a non-programmer simpleton who happens to have time and interest to try these sort of things**.
> 
> Hence, don't expect this to be a reliable and/or readable codebase. This should be treated as a Proof of Concept project since no one else seemed to have tried this as of writing.\
> |\
> Consider creating a fork for reference if you're also interested in building a functional NixOS shimboot or similar.

With that being said, contributions and feedbacks are welcome by opening a [discussion](https://github.com/PopCat19/nixos-shimboot/discussions/new/choose) or an [issue](https://github.com/PopCat19/nixos-shimboot/issues/new) on the main branch. :3

# NixOS Shimboot
I've started this project because no one (from what I've seen) publically created a NixOS bootable shimboot. Hence, this repo is created since the existing scripts from [ading2210/shimboot](https://github.com/ading2210/shimboot) is mostly incompatible to build with a non-FHS distro like NixOS.

Before this repo, I've made a bunch of attempts initially from [nixos-shimboot-legacy](https://github.com/PopCat19/nixos-shimboot-legacy/tree/qemu-method2), which also derived from [shimboot-nixos](https://github.com/PopCat19/shimboot-nixos). 

The reason I made this repo and moved away from [nixos-shimboot-legacy](https://github.com/PopCat19/nixos-shimboot-legacy/tree/qemu-method2) is due to its inherited contributers and commits from [ading2210/shimboot](https://github.com/ading2210/shimboot), which considering substantial amounts of change that's been made compared to the original repo, I decided to initialize a clean repo to avoid potential misconceptions. I will keep the original GPLv3 license except for unfree chromeos artifacts.

So far it sometimes has been unsurprisingly miserable and messy. That being said, it does make progress considerably rewarding. Here's some personally notable achivements so far:
1. "wow, it actually builds??"
2. "how's it booting already!?"
3. "HYPRLANDD LETS GOOOOOOO!!!!!1!!11"

## What's shimboot?
A helpful excerpt from [ading2210/shimboot](https://github.com/ading2210/shimboot)'s [README](https://github.com/PopCat19/shimboot-nixos/raw/refs/heads/main/README.md):
> Shimboot is a collection of scripts for patching a Chrome OS RMA shim to serve as a bootloader for a standard Linux distribution. It allows you to boot a full desktop Debian install on a Chromebook, without needing to unenroll it or modify the firmware.
>
> Chrome OS RMA shims are bootable disk images which are designed to run a variety of diagnostic utilities on Chromebooks, and they'll work even if the device is enterprise enrolled. Unfortunately for Google, there exists a security flaw where the root filesystem of the RMA shim is not verified. This lets us replace the rootfs with anything we want, including a full Linux distribution.
>
> Simply replacing the shim's rootfs doesn't work, as it boots in an environment friendly to the RMA shim, not regular Linux distros. To get around this, a separate bootloader is required to transition from the shim environment to the main rootfs. This bootloader then runs pivot_root to enter the rootfs, where it then starts the init system.
>
> Another problem is encountered at this stage: the Chrome OS kernel will complain about systemd's mounts, and the boot process will hang. A simple workaround is to apply a patch to systemd, and then it can be recompiled and hosted at a repo somewhere.
>
> After copying all the firmware from the recovery image and shim to the rootfs, we're able to boot to a mostly working XFCE desktop.
>
> The main advantages of this approach are that you don't need to touch the device's firmware in order to run Linux. Simply rebooting and unplugging the USB drive will return the device to normal, which can be useful if the device is enterprise enrolled. However, since we are stuck with the kernel from the RMA shim, some features such as audio and suspend may not work.

**TLDR: gnu/linux on (most) chromebooks, except it can run from a persistent USB and can run cool stuff like Arch btw (and most distros) And before you ask, no one tried to shimboot SteamOS/Bazzite as of writing. (even so, your phone could practially run better frames)**

## Why vibecode?
My controversial excuses for vibecoding this project are, but not limited to:
1. Being unapologetically lazy
2. Reading dense docs will inherently make me explode
3. I get to suffer from my lack of understanding in technical concepts whilst making things miserably difficult than it otherwise would've had been and tangentially make others crash out (valid) 
4. Not being the programmer (still hold accountable)
5. Just wanting NixOS and hyprland to run on an locked-down potato chromebook while having access to it, despite it constantly failing out-of-memory after running `nix flake check` for ten decades (4GB with 3.7GB usable is diabolical as hecc)
6. I'm cooked.

**TLDR: "skill issue"**

## Why flake?
Sure, [nixos-shimboot-legacy](https://github.com/PopCat19/nixos-shimboot-legacy) (kinda) worked to build a bootable NixOS with frankenstein scripts running on hopes and dreams, yet it wasn't functional enough to even get past LightDM. 

The user environment is so borked, the system can't even find anything after logging into LightDM. (session PATH was missing core commands: mkdir, systemctl, Hyprland weren't found in the user session, so login fails after LightDM) I really didn't understand why, as if I hadn't realized that we were shoving many, many impure tweaks to get it booting. (consider this the downsides of vibecoding with room-temperature IQ)

Then, I considered using a minimal liveiso image under qemu environment to create a working ROOTFS that most likely has a working user environment came alight. Yet, after attempting that, it was just failure. (In all honesty, it was useless and unecessary to do considering we already have and previously tested nixos-generators to work)

So, I resorted back to [nixos-generators](https://github.com/nix-community/nixos-generators) to try again, this time using flake with `raw-efi` config.

That being said, if it's not possible right now, that's fine and kinda expected. Even if it means using an imperative, impure mess of scripts, if NixOS can work and be actually functional, then it'll be a great foundation to start creating a declarative build, if deemed possible by then.

**TLDR: I want to see if it's realistically possible to create a reproducible (and actually functional) NixOS shimboot. Otherwise, we'll see if NixOS shimboot is possible first.**

## Progress and obstacles
Flake status and roadmap (not a spec) for the current branch:
- [x] Builds without flake errors
- [x] Builds current NixOS configuration via [`nixos-generators`](https://github.com/nix-community/nixos-generators)
- [x] Patches RMA shim's `initramfs` with shimboot bootloader and partitions into p2
- [x] Partitions in ChromeOS format
- [x] Builds bootable shim bootloader
- [x] Builds bootable NixOS
- [x] Builds bootable NixOS with running `kill-frecon` service (allowing graphics within shim)
- [x] Builds functional NixOS with running greeter (LightDM)
- [x] Builds functional NixOS with running user environment
- [x] Builds functional NixOS with running hyprland
- [x] Have functional networking
- [x] `nix-shell -p firefox` works (note limited space without `expand_rootfs`)
- [x] Builds functional NixOS with `nixos-rebuild` support (requires appending `--options disable sandbox` on shim kernels below 5.6 due to missing kernel namespaces)
- [x] Setup minimal base_configuration
- [x] Setup initial main_configuration for hyprland and home-manager
- [x] Implement multi-board compatibility in flake and build derivations (untested)
- [x] Configure base_configuration to have zram
- [ ] Configure local cloned repo to have origin remote to sync from during assembly
- [ ] Configure base_configuration to be minimal whilst keeping lightdm and hyprland to achive lower image size
- [ ] Resolve firewall issues at boot
- [ ] SDDM greeter support
- [ ] Apply proper recovery firmware patches on a vendor p4 partition to support ChromeOS ROOT_A/B boot; see upstream shimboot for reference
- [ ] Refine main_configuration [primarily to fixup qt/gtk theme configurations, bwrap/steam, and rewrite nixos_setup for better experience]
- [ ] Utilize systemd cachix store on local `nixos-rebuild` to avoid an eternal compilation on potato hardware
- [ ] Create main_configuration template for those who wish to port their own NixOS/HM configurations :3
- [ ] Refine and cleanup scripts and helpers
- [ ] Refine and cleanup base and main configurations
- [ ] Attempt to implement NixOS generation selector within bootstrapper (if possible)
- [ ] Build functional NixOS with LUKS2 support (never done this in my life ;-;)

Current obstacles:
- ChromeOS ROOT_A/B boot: vendor p4 fails to copy (or bind-mount?) donor modules and firmware to tmp, causing ChromeOS init to fail. Need to understand how upstream shimboot handled this.
- SDDM greeter support: previous attempts resulted in a blank backlit screen after kill-frecon. Need to evaluate logs and understand how SDDM can be supported declaratively.
- bwrap/steam: NixOS doesn't follow FHS. Need to understand how and if this can be implemented declaratively, or with helper scripts.
- firewall issues at boot: firewall service fails to start during boot. Need to evaluate logs and understand if firewall can be supported declaratively.

## Binary cache for patched systemd

This project, in fact, already has a Cachix binary cache for the patched systemd. It's still not implemented yet, but here's some info about it:

- Substituter: https://shimboot-systemd-nixos.cachix.org
- Trusted public key: `shimboot-systemd-nixos.cachix.org-1:vCWmEtJq7hA2UOLN0s3njnGs9/EuX06kD7qOJMo2kAA=`

If you maintain your own configuration, add:
```nix
  nix.settings.substituters = [ "https://shimboot-systemd-nixos.cachix.org" ];
  nix.settings.trusted-public-keys = [ "shimboot-systemd-nixos.cachix.org-1:vCWmEtJq7hA2UOLN0s3njnGs9/EuX06kD7qOJMo2kAA=" ];
```

## The Sauce
Bootloader and systemd patches as well as the reference for bootstrapping, partitioning, and workarounds are sourced from: [ading2210/shimboot](https://github.com/ading2210/shimboot) and [ading2210/chromeos-systemd](https://github.com/ading2210/chromeos-systemd)

Miscellaneously, my current dev enviroment consists of:
- [NixOS+Hyprland](https://github.com/PopCat19/popcat19-nixos-hm)
- [VSCodium](https://github.com/VSCodium/vscodium)
  - [Kilo Code](https://github.com/Kilo-Org/kilocode)
    - Common APIs: [ChutesAI](https://chutes.ai/), [Kilo](https://kilocode.ai/docs/providers/kilocode), [OpenRouter](https://openrouter.ai/)
    - Common models: 
      1. [`openai/gpt-5-codex`](https://openrouter.ai/openai/gpt-5-codex)
      2. [`z-ai/glm-4.6`](https://openrouter.ai/z-ai/glm-4.6)
      3. [`anthropic/claude-sonnet-4.5`](https://openrouter.ai/anthropic/claude-sonnet-4.5)
    - Common MCPs: 
      [context7](https://github.com/upstash/context7), [exa](https://github.com/exa-labs/exa-mcp-server), [sequential-thinking](https://github.com/arben-adm/mcp-sequential-thinking), [filesystem](https://github.com/mark3labs/mcp-filesystem-server)

## Credits:
- [ading2210](https://github.com/ading2210) - for creating the [original shimboot repository](https://github.com/ading2210/shimboot) and giving me an idea to generate NixOS shimboot
- [ading2210/shimboot](https://github.com/ading2210/shimboot) - `bootloader/` source
- [ading2210/chromeos-systemd](https://github.com/ading2210/chromeos-systemd) - systemd `mount_nofollow` patch source to resolve/workaround `Failed to mount API filesystems` error
- [discussion thread](https://github.com/ading2210/shimboot/discussions/335) - useful feedbacks from my idea
- [nixos-generators](https://github.com/nix-community/nixos-generators) - builds nixos image from a configuration for use in ROOTFS

## License

### Project Code: GPL-3.0-or-later

All original code in this repository is licensed under **GPLv3** (see [LICENSE](LICENSE)).

This includes:
- Nix flake configurations (`flake.nix`, `flake_modules/`)
- NixOS system modules (`shimboot_config/`)
- Build and utility scripts (`scripts/`, `assemble-final.sh`, etc.)
- Bootloader integration code (`bootloader/` - originally derived from upstream shimboot)

### Proprietary Components: Unfree

The following components are **NOT** covered by GPLv3 and remain proprietary:
- ChromeOS RMA shims (© Google LLC)
- ChromeOS recovery images (© Google LLC)  
- Extracted kernel modules, firmware blobs, and drivers
- Board-specific artifacts (e.g., `dedede-manifest.nix`)

### Nix Derivation Handling
Derivations that extract or process ChromeOS artifacts are marked with:
```nix
meta.license = lib.licenses.unfree;
```

And are allowed via:
```nix
config.allowUnfreePredicate = pkg:
  builtins.elem (lib.getName pkg) [
    "chromeos-shim"
    "chromeos-recovery"
    "extracted-kernel"
    "initramfs-extraction"
    "initramfs-patching"
  ];
```
