# NixOS Shimboot â€” Current Project State (Temporary Summary)
Generated: 2025-10-24T09:28:50.503Z (UTC)

Overview and goals
- Purpose: boot a full NixOS system on enterprise-enrolled Chromebooks by repurposing a ChromeOS RMA "shim" as an initial bootloader and pivoting into a persistent Linux rootfs.
- Upstream idea: see [README.md](README.md) for background and caveats. Treat this repository as a POC; contributions and issue reports welcome.

Architecture and build pipeline
1) Flake composition
- Entrypoint: [flake.nix](flake.nix)
- Inputs: nixpkgs (nixos-unstable), nixos-generators, home-manager, zen-browser, rose-pine-hyprcursor.
- Outputs:
  - Packages: merged from raw image generation and ChromeOS/initramfs modules at [flake.nix](flake.nix:48).
  - Default package: raw rootfs image at [flake.nix](flake.nix:62).
  - Dev shells: from development environment module at [flake.nix](flake.nix:65).
  - nixosConfigurations: base and main system variants at [flake.nix](flake.nix:71).

2) Image generation (nixos-generators)
- Full image ("raw-rootfs"): [nix.nixosGenerate()](flake_modules/raw-image.nix:15) using main configuration plus Home Manager.
- Minimal image ("raw-rootfs-minimal"): [nix.nixosGenerate()](flake_modules/raw-image.nix:68) using base configuration only.
- Both set sane defaults (serial console, flakes enabled, GC) starting near [flake_modules/raw-image.nix](flake_modules/raw-image.nix:51) and [flake_modules/raw-image.nix:78).
- Overlays applied for additional packages and themes.

3) System configurations
- Base-only and full system are exposed as nixosConfigurations:
  - Minimal: [nix.nixosSystem()](flake_modules/system-configuration.nix:73)
  - Main: [nix.nixosSystem()](flake_modules/system-configuration.nix:80)
- Hostname is read from user config to name the targets; legacy compat aliases begin at [flake_modules/system-configuration.nix](flake_modules/system-configuration.nix:87).

4) Bootloader and pivot
- Early /init: [bash.main()](bootloader/bin/init:28) installs BusyBox applets and delegates to bootstrap via [bootloader/bin/bootstrap.sh](bootloader/bin/bootstrap.sh) after [bash.detect_tty()](bootloader/bin/init:13).
- Menu and selection: [bash.print_selector()](bootloader/bin/bootstrap.sh:226) and [bash.get_selection()](bootloader/bin/bootstrap.sh:256) enumerate ChromeOS ROOT-A/B and any GPT partitions labeled for shimboot.
- Vendor driver/firmware integration: [bash.find_vendor_partition()](bootloader/bin/bootstrap.sh:86) and [bash.bind_vendor_into()](bootloader/bin/bootstrap.sh:139) mount a "shimboot_vendor" partition and bind its modules/firmware into the real root before pivot.
- Pivot into Linux: [bash.boot_target()](bootloader/bin/bootstrap.sh:422) mounts the selected rootfs (ext4 or LUKS) and performs pivot_root; console handoff is handled for frecon-lite if available.
- ChromeOS pass-through mode: [bash.boot_chromeos()](bootloader/bin/bootstrap.sh:472) can boot CrOS ROOT partitions while staging donor modules/firmware when needed.

5) Initramfs patching pipeline and ChromeOS sources
- Flake wires in modules for kernel/initramfs extraction and patching under [flake_modules/patch_initramfs](flake_modules/patch_initramfs), and ChromeOS source retrieval under [flake_modules/chromeos-sources.nix](flake_modules/chromeos-sources.nix).
- Board artifacts are referenced via [dedede-manifest.nix](dedede-manifest.nix) (split zip manifest for "dedede").

6) Imaging and safety tooling
- Interactive, safety-first writer: [write-shimboot-image.sh](write-shimboot-image.sh)
  - Discovery and filtering: [bash.list_candidates()](write-shimboot-image.sh:407), system disk detection and ignore lists.
  - Safety gates: [bash.validate_output_device()](write-shimboot-image.sh:560), auto-unmount via [bash.ensure_unmounted()](write-shimboot-image.sh:526), large-device confirmation.
  - Execution: [bash.run_writer()](write-shimboot-image.sh:674) using dd with progress; orchestrated by [bash.main()](write-shimboot-image.sh:765) and privilege guard [bash.require_root()](write-shimboot-image.sh:170).

System configurations (what's in "base" vs "main")
- Base system: [shimboot_config/base_configuration/configuration.nix](shimboot_config/base_configuration/configuration.nix)
  - Imports core system modules at [shimboot_config/base_configuration/configuration.nix](shimboot_config/base_configuration/configuration.nix:9) for boot, networking, filesystems, hardware, systemd, users, audio, display, fish, services, etc.
  - Nix settings: enables Cachix substituter for patched systemd (README), sets trusted users; see [shimboot_config/base_configuration/configuration.nix](shimboot_config/base_configuration/configuration.nix:30).
  - Shell and state: fish enabled; stateVersion pinned at [shimboot_config/base_configuration/configuration.nix](shimboot_config/base_configuration/configuration.nix:37).
- Main system: [shimboot_config/main_configuration/configuration.nix](shimboot_config/main_configuration/configuration.nix)
  - Layers on base and adds fonts, packages, services, and display tweaks; see imports at [shimboot_config/main_configuration/configuration.nix](shimboot_config/main_configuration/configuration.nix:8).
- Home Manager integration
  - For full builds: wired in both during flake system builds at [flake_modules/system-configuration.nix](flake_modules/system-configuration.nix:43) and during image generation at [flake_modules/raw-image.nix](flake_modules/raw-image.nix:25).
  - HM receives zen-browser and userConfig as extraSpecialArgs; home modules are split under [shimboot_config/main_configuration/home_modules](shimboot_config/main_configuration/home_modules).

Current capability checklist (from README)
- Build status: flake evaluates; raw images build; bootloader and NixOS boot successfully; Hyprland sessions run; networking works; nixos-rebuild supported (with kernel namespace caveat).
- Usability: basic greeter and user session functional; firefox via nix-shell works (watch space); functional NixOS with running hyprland, LightDM, and user environment.
- Infrastructure: initial base and main configurations land; Home Manager and Hyprland setup included; overlays for additional theming and packages.
- Known work still planned:
  - Multi-board compatibility (BOARD= fallback; currently "dedede" manifest present).
  - Recovery firmware patches to support ROOT_A/B mirroring.
  - Main configuration polish (GTK/Qt themes, bwrap/Steam, hyprpanel/dunst, install experience).
  - Systemd cache via Cachix to tame rebuilds on low-RAM devices.
  - Script and helper cleanup; NixOS generation selector in bootloader (TBD feasibility).
  - LUKS2 support.

Notable design choices and constraints
- Pinned nixos-unstable and flake-native workflows to keep builds reproducible while iterating.
- BusyBox-based bootloader minimizes userspace footprint inside the shim environment.
- Vendor driver/firmware binding avoids mutating ChromeOS roots and reduces memory pressure.
- Raw image path chosen to reduce on-target build time; patched systemd cache planned but not yet enforced.
- Added overlays for theming (rose-pine-hyprcursor) and additional packages.

How to build and test today (indicative)
- Build the raw rootfs image (default package): `nix build` or `nix build .#raw-rootfs` (artifact symlinked at ./result)
- Build minimal image: `nix build .#raw-rootfs-minimal`
- Flash to a removable device (interactive and safe): run [write-shimboot-image.sh](write-shimboot-image.sh) with appropriate flags; point `-i` to the image under `./result`, e.g.:
  - `sudo ./write-shimboot-image.sh --list`
  - `sudo ./write-shimboot-image.sh -i "$(readlink -f ./result)" --output /dev/sdX`
- Note: parts of the initramfs patching workflow and ChromeOS artifact preparation may require `--impure` or manual steps; see modules under [flake_modules/patch_initramfs](flake_modules/patch_initramfs) and scripts in [tools/](tools/).

Directory highlights
- Bootloader: [bootloader/bin/init](bootloader/bin/init), [bootloader/bin/bootstrap.sh](bootloader/bin/bootstrap.sh)
- Flake modules (core): [flake_modules/raw-image.nix](flake_modules/raw-image.nix), [flake_modules/system-configuration.nix](flake_modules/system-configuration.nix)
- Flake modules (ChromeOS/initramfs): [flake_modules/chromeos-sources.nix](flake_modules/chromeos-sources.nix), [flake_modules/patch_initramfs/initramfs-extraction.nix](flake_modules/patch_initramfs/initramfs-extraction.nix), [flake_modules/patch_initramfs/initramfs-patching.nix](flake_modules/patch_initramfs/initramfs-patching.nix), [flake_modules/patch_initramfs/kernel-extraction.nix](flake_modules/patch_initramfs/kernel-extraction.nix)
- System configs: [shimboot_config/base_configuration](shimboot_config/base_configuration), [shimboot_config/main_configuration](shimboot_config/main_configuration)
- Home modules and Hyprland setup: [shimboot_config/main_configuration/home_modules](shimboot_config/main_configuration/home_modules), [shimboot_config/main_configuration/hypr_config](shimboot_config/main_configuration/hypr_config)
- ChromeOS artifacts: [dedede-manifest.nix](dedede-manifest.nix)
- Utilities and helpers: [tools/](tools/), [assemble-final.sh](assemble-final.sh), [inspect-image.sh](inspect-image.sh), [fetch-manifest.sh](fetch-manifest.sh)
- Overlays: [overlays/](overlays/)

Binary cache for patched systemd (planned integration)
- Substituter: https://shimboot-systemd-nixos.cachix.org
- Trusted public key: shimboot-systemd-nixos.cachix.org-1:vCWmEtJq7hA2UOLN0s3njnGs9/EuX06kD7qOJMo2kAA=
- Base config already sets the Cachix endpoints at [shimboot_config/base_configuration/configuration.nix](shimboot_config/base_configuration/configuration.nix:31).

Recent changes (from git log)
- workflow(flake-update-recovery): remove uneeded
- feat: automate fetch-recovery.sh with ChromeOS Releases JSON API and add CI workflow
- feat: automate fetch-recovery.sh with ChromeOS Releases JSON API
- feat: add automated ChromeOS recovery image updates via CI
- feat: comprehensive board build testing and recovery validation
- fix: update board build test to focus on critical recovery components
- feat: add comprehensive board build testing script
- refactor: remove old project state files from root (moved to snapshots/)
- docs: add LLM development workflow guidelines and unignore llm-notes directory
- refactor: organize project state snapshots into dedicated snapshots/ directory

Appendix: quick links to important functions
- Bootloader init: [bash.detect_tty()](bootloader/bin/init:13), [bash.main()](bootloader/bin/init:28)
- Bootloader core: [bash.main()](bootloader/bin/bootstrap.sh:608), [bash.print_selector()](bootloader/bin/bootstrap.sh:226), [bash.get_selection()](bootloader/bin/bootstrap.sh:256), [bash.boot_target()](bootloader/bin/bootstrap.sh:422), [bash.boot_chromeos()](bootloader/bin/bootstrap.sh:472), [bash.bind_vendor_into()](bootloader/bin/bootstrap.sh:139)
- Imaging tool: [bash.parse_args()](write-shimboot-image.sh:696), [bash.list_candidates()](write-shimboot-image.sh:407), [bash.validate_output_device()](write-shimboot-image.sh:560), [bash.ensure_unmounted()](write-shimboot-image.sh:526), [bash.run_writer()](write-shimboot-image.sh:674), [bash.main()](write-shimboot-image.sh:765)

Attribution
- Sources and patches follow upstream work: [README.md](README.md) credits [ading2210/shimboot](https://github.com/ading2210/shimboot) and [ading2210/chromeos-systemd](https://github.com/ading2210/chromeos-systemd).